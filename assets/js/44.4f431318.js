(window.webpackJsonp=window.webpackJsonp||[]).push([[44],{388:function(t,a,e){"use strict";e.r(a);var s=e(25),r=Object(s.a)({},(function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"执行脚本"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#执行脚本"}},[t._v("#")]),t._v(" 执行脚本 (eval)")]),t._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("提示")]),t._v(" "),e("p",[t._v("本章节将同时介绍 koishi-plugin-eval 和 koishi-plugin-eval-addons 两个插件，后者的功能将作为前者的补充。")])]),t._v(" "),e("div",{staticClass:"custom-block warning"},[e("p",{staticClass:"custom-block-title"},[t._v("注意")]),t._v(" "),e("p",[t._v("由于这两个插件使用了许多最新的特性。目前使用 koishi-plugin-eval 的功能需要你的 Node 版本不小于 14.6，并运行时附上 "),e("code",[t._v("--enable-source-maps")]),t._v("。如果要使用 koishi-plugin-eval-addons，还需要额外附上 "),e("code",[t._v("--experimental-vm-modules")]),t._v(" 参数。")])]),t._v(" "),e("p",[t._v("koishi-plugin-eval 允许用户直接使用机器人执行脚本。它利用了 Node.js 的 vm 和 worker_thread 模块，在保护执行安全的前提下能够获得较快的响应速度。同时，插件还提供了一些内置的 API 供用户调用，结合教学功能可以在客户端实现复杂的行为。")]),t._v(" "),e("p",[t._v("koishi-plugin-eval-addons 在前一个插件的基础上，允许用户编写自己的模块并永久保存。插件将自动加载特定目录下的文件，并将其作为机器人的内置功能。用户可以利用此功能存储较为复杂的代码，甚至扩展新的指令。同时，如果上述目录是一个 git 目录，该插件也提供了自动更新等机制。")]),t._v(" "),e("h2",{attrs:{id:"沙箱-api"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#沙箱-api"}},[t._v("#")]),t._v(" 沙箱 API")]),t._v(" "),e("p",[t._v("evaluate 指令会创建一个沙箱环境。这个沙箱环境支持 ES2020 的全部特性，外加 "),e("a",{attrs:{href:"https://nodejs.org/dist/latest-v14.x/docs/api/buffer.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Buffer"),e("OutboundLink")],1),t._v("。除此以外，还支持下面的属性和方法：")]),t._v(" "),e("h3",{attrs:{id:"user"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#user"}},[t._v("#")]),t._v(" user")]),t._v(" "),e("ul",[e("li",[t._v("类型: "),e("code",[t._v("Partial<User>")])])]),t._v(" "),e("p",[t._v("调用者的用户数据。")]),t._v(" "),e("h3",{attrs:{id:"send"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#send"}},[t._v("#")]),t._v(" send(...param)")]),t._v(" "),e("ul",[e("li",[e("strong",[t._v("param:")]),t._v(" "),e("code",[t._v("any[]")]),t._v(" 要发送的内容")]),t._v(" "),e("li",[t._v("返回值: "),e("code",[t._v("Promise<void>")])])]),t._v(" "),e("p",[t._v("向当前上下文发送一条消息。")]),t._v(" "),e("h3",{attrs:{id:"exec"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#exec"}},[t._v("#")]),t._v(" exec(message)")]),t._v(" "),e("ul",[e("li",[e("strong",[t._v("message:")]),t._v(" "),e("code",[t._v("string")]),t._v(" 指令文本")]),t._v(" "),e("li",[t._v("返回值: "),e("code",[t._v("Promise<void>")])])]),t._v(" "),e("p",[t._v("在当前上下文执行一条指令。")]),t._v(" "),e("h3",{attrs:{id:"utils"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#utils"}},[t._v("#")]),t._v(" utils "),e("Badge",{attrs:{text:"addons"}})],1),t._v(" "),e("p",[t._v("如果你使用了 koishi-plugin-eval-addons，部分 koishi-utils 的功能将作为一个独立模块暴露在全局对象上，它包含了下列属性：")]),t._v(" "),e("ul",[e("li",[t._v("CQCode")]),t._v(" "),e("li",[t._v("Random")]),t._v(" "),e("li",[t._v("Time")])]),t._v(" "),e("h2",{attrs:{id:"主线程-api"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#主线程-api"}},[t._v("#")]),t._v(" 主线程 API")]),t._v(" "),e("h3",{attrs:{id:"datatrap"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#datatrap"}},[t._v("#")]),t._v(" DataTrap")]),t._v(" "),e("h4",{attrs:{id:"trap-define"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#trap-define"}},[t._v("#")]),t._v(" trap.define")]),t._v(" "),e("h4",{attrs:{id:"trap-get"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#trap-get"}},[t._v("#")]),t._v(" trap.get")]),t._v(" "),e("h4",{attrs:{id:"trap-set"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#trap-set"}},[t._v("#")]),t._v(" trap.set")]),t._v(" "),e("h4",{attrs:{id:"trap-fields"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#trap-fields"}},[t._v("#")]),t._v(" trap.fields")]),t._v(" "),e("h4",{attrs:{id:"usertrap"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#usertrap"}},[t._v("#")]),t._v(" userTrap")]),t._v(" "),e("h4",{attrs:{id:"grouptrap"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#grouptrap"}},[t._v("#")]),t._v(" groupTrap")]),t._v(" "),e("h4",{attrs:{id:"attachtraps"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#attachtraps"}},[t._v("#")]),t._v(" attachTraps")]),t._v(" "),e("h3",{attrs:{id:"mainapi"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#mainapi"}},[t._v("#")]),t._v(" MainAPI")]),t._v(" "),e("h3",{attrs:{id:"app-worker"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#app-worker"}},[t._v("#")]),t._v(" app.worker")]),t._v(" "),e("h2",{attrs:{id:"子线程-api"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#子线程-api"}},[t._v("#")]),t._v(" 子线程 API")]),t._v(" "),e("h3",{attrs:{id:"config"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#config"}},[t._v("#")]),t._v(" config")]),t._v(" "),e("h3",{attrs:{id:"response"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#response"}},[t._v("#")]),t._v(" response")]),t._v(" "),e("h3",{attrs:{id:"mapdirectory"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#mapdirectory"}},[t._v("#")]),t._v(" mapDirectory")]),t._v(" "),e("h3",{attrs:{id:"workerapi"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#workerapi"}},[t._v("#")]),t._v(" WorkerAPI")]),t._v(" "),e("h3",{attrs:{id:"internal"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#internal"}},[t._v("#")]),t._v(" internal")]),t._v(" "),e("h4",{attrs:{id:"internal-contextify"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#internal-contextify"}},[t._v("#")]),t._v(" internal.contextify(value)")]),t._v(" "),e("h4",{attrs:{id:"internal-decontextify"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#internal-decontextify"}},[t._v("#")]),t._v(" internal.decontextify(value)")]),t._v(" "),e("h4",{attrs:{id:"internal-setglobal"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#internal-setglobal"}},[t._v("#")]),t._v(" internal.setGlobal(name, value, writable)")]),t._v(" "),e("h4",{attrs:{id:"internal-connect"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#internal-connect"}},[t._v("#")]),t._v(" internal.connect(outer, inner)")]),t._v(" "),e("h3",{attrs:{id:"formaterror"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#formaterror"}},[t._v("#")]),t._v(" formatError(error)")]),t._v(" "),e("h3",{attrs:{id:"synthetize"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#synthetize"}},[t._v("#")]),t._v(" synthetize(identifier, namespace, name) "),e("Badge",{attrs:{text:"addons"}})],1),t._v(" "),e("h2",{attrs:{id:"安全性"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安全性"}},[t._v("#")]),t._v(" 安全性")]),t._v(" "),e("h3",{attrs:{id:"使用陷阱"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用陷阱"}},[t._v("#")]),t._v(" 使用陷阱")]),t._v(" "),e("p",[t._v("koishi-plugin-eval 提供了一套陷阱 API。它会影响 evaluate 指令和扩展指令中的用户数据。你可以通过下面的方式来定义一个陷阱：")]),t._v(" "),e("panel-view",{staticClass:"code",attrs:{title:""}},[e("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[e("code",[e("span",{staticStyle:{color:"#F92672"}},[t._v("import")]),e("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" { userTrap } ")]),e("span",{staticStyle:{color:"#F92672"}},[t._v("from")]),e("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),e("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi-plugin-eval'")]),t._v("\n\n"),e("span",{staticStyle:{color:"#F8F8F2"}},[t._v("userTrap.")]),e("span",{staticStyle:{color:"#A6E22E"}},[t._v("define")]),e("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),e("span",{staticStyle:{color:"#E6DB74"}},[t._v("'foo'")]),e("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", {")]),t._v("\n"),e("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  fields: [")]),e("span",{staticStyle:{color:"#E6DB74"}},[t._v("'bar'")]),e("span",{staticStyle:{color:"#F8F8F2"}},[t._v("],")]),t._v("\n"),e("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),e("span",{staticStyle:{color:"#A6E22E"}},[t._v("get")]),e("span",{staticStyle:{color:"#F8F8F2"}},[t._v(": ")]),e("span",{staticStyle:{color:"#FD971F"}},[t._v("user")]),e("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),e("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),e("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" user.bar,")]),t._v("\n"),e("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),e("span",{staticStyle:{color:"#A6E22E"}},[t._v("set")]),e("span",{staticStyle:{color:"#F8F8F2"}},[t._v(": (")]),e("span",{staticStyle:{color:"#FD971F"}},[t._v("user")]),e("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),e("span",{staticStyle:{color:"#FD971F"}},[t._v("value")]),e("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") ")]),e("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),e("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" user.bar ")]),e("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),e("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" value,")]),t._v("\n"),e("span",{staticStyle:{color:"#F8F8F2"}},[t._v("})")])])])]),e("p",[t._v("这样一来，当用户在沙箱中尝试访问 "),e("code",[t._v("user.foo")]),t._v(" 时，访问到的实际上是 "),e("code",[t._v("user.bar")]),t._v(" 的数据。")]),t._v(" "),e("p",[t._v("当然，陷阱 API 能做的事远比上面的例子强大。假如一些数据的计算更适合在主线程完成，你就可以通过陷阱来将已经计算好的数据暴露给子线程。")]),t._v(" "),e("h3",{attrs:{id:"禁用部分指令"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#禁用部分指令"}},[t._v("#")]),t._v(" 禁用部分指令")]),t._v(" "),e("p",[t._v("如果你担心在 evaluate 中调用部分指令存在风险，你可以手动将这些指令设置为禁止在沙箱中调用：")]),t._v(" "),e("panel-view",{staticClass:"code",attrs:{title:""}},[e("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[e("code",[e("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.")]),e("span",{staticStyle:{color:"#A6E22E"}},[t._v("command")]),e("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),e("span",{staticStyle:{color:"#E6DB74"}},[t._v("'foo'")]),e("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", { noEval: ")]),e("span",{staticStyle:{color:"#AE81FF"}},[t._v("true")]),e("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" })")])])])]),e("panel-view",{attrs:{title:"聊天记录"}},[e("chat-message",{attrs:{nickname:"Alice",color:"#cc0066"}},[t._v("> exec('foo')")]),t._v(" "),e("chat-message",{attrs:{nickname:"Koishi",avatar:"/koishi.png"}},[t._v("不能在 evaluate 指令中调用 foo 指令。")])],1),t._v(" "),e("p",[t._v("默认情况下，evaluate 指令本身也是禁止在沙箱中调用的。")]),t._v(" "),e("h2",{attrs:{id:"配置项"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置项"}},[t._v("#")]),t._v(" 配置项")]),t._v(" "),e("p",[t._v("请注意标有 "),e("Badge",{attrs:{text:"addons",vertical:"baseline"}}),t._v(" 的配置项需要配合 koishi-plugin-eval-addons 使用。但你可以将相应的参数传给任何一个插件，效果是等价的。")],1),t._v(" "),e("h3",{attrs:{id:"prefix"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#prefix"}},[t._v("#")]),t._v(" prefix")]),t._v(" "),e("ul",[e("li",[t._v("类型: "),e("code",[t._v("string")])]),t._v(" "),e("li",[t._v("默认值: "),e("code",[t._v("'>'")])])]),t._v(" "),e("p",[t._v("快捷调用的前缀字符。设置为 "),e("code",[t._v("null")]),t._v(" 可以取消 evaluate 指令的快捷调用。")]),t._v(" "),e("h3",{attrs:{id:"timeout"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#timeout"}},[t._v("#")]),t._v(" timeout")]),t._v(" "),e("ul",[e("li",[t._v("类型: "),e("code",[t._v("number")])]),t._v(" "),e("li",[t._v("默认值: "),e("code",[t._v("1000")])])]),t._v(" "),e("p",[t._v("单轮 evaluate 指令执行过程允许的最大等待时长，单位为毫秒。")]),t._v(" "),e("h3",{attrs:{id:"maxlogs"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#maxlogs"}},[t._v("#")]),t._v(" maxLogs")]),t._v(" "),e("ul",[e("li",[t._v("类型: "),e("code",[t._v("number")])])]),t._v(" "),e("p",[t._v("单轮 evaluate 指令执行过程中允许 "),e("a",{attrs:{href:"#send"}},[e("code",[t._v("send")])]),t._v(" 被调用的最大次数。")]),t._v(" "),e("h3",{attrs:{id:"userfields"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#userfields"}},[t._v("#")]),t._v(" userFields")]),t._v(" "),e("ul",[e("li",[t._v("类型: "),e("code",[t._v("string[]")])]),t._v(" "),e("li",[t._v("默认值: "),e("code",[t._v("['id', 'authority']")])])]),t._v(" "),e("p",[t._v("能够在 evaluate 指令中被访问的用户字段列表。这里的字段也是受 "),e("a",{attrs:{href:"#%E4%BD%BF%E7%94%A8%E9%99%B7%E9%98%B1"}},[t._v("陷阱")]),t._v(" 影响的。")]),t._v(" "),e("h3",{attrs:{id:"resourcelimits"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#resourcelimits"}},[t._v("#")]),t._v(" resourceLimits")]),t._v(" "),e("ul",[e("li",[t._v("类型: "),e("a",{attrs:{href:"https://nodejs.org/api/worker_threads.html#worker_threads_worker_resourcelimits",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("ResourceLimits")]),e("OutboundLink")],1)])]),t._v(" "),e("p",[t._v("对子线程的资源限制。")]),t._v(" "),e("h3",{attrs:{id:"setupfiles"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#setupfiles"}},[t._v("#")]),t._v(" setupFiles")]),t._v(" "),e("ul",[e("li",[t._v("类型: "),e("code",[t._v("Record<string, string>")])])]),t._v(" "),e("p",[t._v("要在子线程执行的文件名的键值对。键表示你希望在报错信息中显示的模块名，值表示文件的实际路径。如果你要扩展 eval 插件在子线程的行为，你可能需要这个选项。")]),t._v(" "),e("h3",{attrs:{id:"inspect"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#inspect"}},[t._v("#")]),t._v(" inspect")]),t._v(" "),e("ul",[e("li",[t._v("类型: "),e("a",{attrs:{href:"https://nodejs.org/api/util.html#util_util_formatwithoptions_inspectoptions_format_args",target:"_blank",rel:"noopener noreferrer"}},[e("code",[t._v("InspectOptions")]),e("OutboundLink")],1)])]),t._v(" "),e("p",[t._v("用于将传入 "),e("a",{attrs:{href:"#send"}},[e("code",[t._v("send")])]),t._v(" 方法的参数转化成字符串的配置项。")]),t._v(" "),e("h3",{attrs:{id:"gitremote"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#gitremote"}},[t._v("#")]),t._v(" gitRemote "),e("Badge",{attrs:{text:"addons"}})],1),t._v(" "),e("ul",[e("li",[t._v("类型: "),e("code",[t._v("string")])])]),t._v(" "),e("p",[t._v("扩展模块更新时的 remote 链接。")]),t._v(" "),e("h3",{attrs:{id:"moduleroot"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#moduleroot"}},[t._v("#")]),t._v(" moduleRoot "),e("Badge",{attrs:{text:"addons"}})],1),t._v(" "),e("ul",[e("li",[t._v("类型: "),e("code",[t._v("string")])])]),t._v(" "),e("p",[t._v("扩展模块的根目录路径。")])],1)}),[],!1,null,null,null);a.default=r.exports}}]);