(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{400:function(t,s,a){"use strict";a.r(s);var o=a(25),c=Object(o.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"v2-新特性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#v2-新特性"}},[t._v("#")]),t._v(" v2 新特性")]),t._v(" "),a("p",[t._v("这个页面将介绍 Koishi v2 的新特性。")]),t._v(" "),a("h2",{attrs:{id:"钩子函数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#钩子函数"}},[t._v("#")]),t._v(" 钩子函数")]),t._v(" "),a("p",[t._v("Koishi v1 的 "),a("code",[t._v("ctx.receiver")]),t._v(" 使用了 EventEmitter 来分发事件，而 Koishi v2 则自己实现了一个事件系统。这样做将带来几点好处：")]),t._v(" "),a("ul",[a("li",[t._v("使用统一的事件分发机制，无需对每个上下文构造 EventEmitter 实例，具有更高的性能")]),t._v(" "),a("li",[a("code",[t._v("emit")]),t._v(", "),a("code",[t._v("parallel")]),t._v(", "),a("code",[t._v("bail")]),t._v(", "),a("code",[t._v("serial")]),t._v(" 等方法能够妥善处理不同场景下的事件回调")])]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("emit")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()      ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 同时触发，返回 void")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("bail")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()      ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 依次触发，返回第一个 non-nullable 的结果")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("parallel")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()  ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 同时触发，返回一个全部完成的 Promise")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("serial")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()    ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 依次触发，返回第一个 resolve non-nullable 的结果")])])])]),a("p",[t._v("相关 API 的迁移方法如下：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.receiver.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("on")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(event, callback)    ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("on")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(event, callback)")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.receiver.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("emit")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(event, ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("...")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("args)   ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("emit")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(event, ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("...")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("args)")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.app.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("emitEvent")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("...")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("args)          ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("emit")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("...")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("args)")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.options.maxMiddlewares          ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  app.options.maxListeners")])])])]),a("h2",{attrs:{id:"会话接口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#会话接口"}},[t._v("#")]),t._v(" 会话接口")]),t._v(" "),a("p",[t._v("Koishi v2 新增了会话的概念，它向下兼容大部分 Koishi v1 元信息对象的特性，并增加了大量方法：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.$app              ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// App 实例")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.$bot              ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// Bot 实例")]),t._v("\n\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("$send")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()           ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 发送消息")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("$sendQueued")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()     ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 延时发送消息")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("$cancelQueued")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()   ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 取消延时队列")]),t._v("\n\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("$use")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()            ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 注册仅对当前会话生效的中间件")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("$prompt")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()         ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 等待一条消息")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("$suggest")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()        ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 书写错误提示")]),t._v("\n\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("$resolve")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()        ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 解析 Argv 对象")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("$parse")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()          ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 解析指令文本")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("$execute")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()        ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 指令指令")]),t._v("\n\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("$observeUser")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()    ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 绑定可观测用户实例")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("$observeGroup")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()   ")]),a("span",{staticStyle:{color:"#75715E"}},[t._v("// 绑定可观测群实例")])])])]),a("h2",{attrs:{id:"单一应用实例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#单一应用实例"}},[t._v("#")]),t._v(" 单一应用实例")]),t._v(" "),a("p",[t._v("Koishi v2 使用单一的 App 实例管理多个机器人账号，这将大幅提高程序的启动速度。")]),t._v(" "),a("p",[t._v("现在可以通过 "),a("code",[t._v("ctx.bots")]),t._v(" 访问当前 App 下的所有机器人，也可以用 "),a("code",[t._v("session.$app")]),t._v(" 和 "),a("code",[t._v("session.$bot")]),t._v(" 访问当前会话所在的 App 和 Bot 实例了。")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("appMap[selfId].sender       ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.bots[selfId]")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("appList.")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("forEach")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(cb)         ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.bots.")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("forEach")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(cb)")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.sender.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("sendGroupMsg")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()   ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.bots[selfId].")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("sendGroupMsg")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()")]),t._v("\n\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("appMap[selfId]              ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  session.$app")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("appMap[selfId].sender       ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  session.$bot")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.sender.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("sendGroupMsg")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()   ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  session.$bot.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("sendGroupMsg")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()")]),t._v("\n\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.selfId                  ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  bot.selfId")]),t._v("\n"),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("getSelfIds")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()                ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  app.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("getSelfIds")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()")])])])]),a("p",[t._v("同时我们也不再需要全局的生命周期方法了。直接使用 v1 就有的生命周期方法即可控制所有 Bot 实例。")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#A6E22E"}},[t._v("startAll")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()              ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  app.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("start")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()")]),t._v("\n"),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("stopAll")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()               ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  app.")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("stop")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()")]),t._v("\n\n"),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("onStart")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(cb)             ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("on")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'connect'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", cb)")]),t._v("\n"),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("onStop")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(cb)              ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("on")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'disconnect'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", cb)")])])])]),a("h2",{attrs:{id:"指令选项"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#指令选项"}},[t._v("#")]),t._v(" 指令选项")]),t._v(" "),a("p",[t._v("Koishi v1 的指令系统对 TypeScript 的类型标注并不友好。为了更好地适应强类型和按需获取数据的程序风格，Koishi v2 修改了指令选项的行为：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticStyle:{color:"#75715E"}},[t._v("// v1")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("cmd.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("option")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'-f, --foo <arg>'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'description'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", { default: ")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("123")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" })")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("cmd.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("option")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'-B, --no-bar'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'description'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("cmd.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("option")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'--baz <arg>'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'description'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", { isString: ")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("true")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" })")]),t._v("\n\n"),a("span",{staticStyle:{color:"#75715E"}},[t._v("// v2")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("cmd.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("option")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'foo'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'-f <arg> description'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", { fallback: ")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("123")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" })")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("cmd.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("option")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'bar'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'-B description'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", { value: ")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("false")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" })")]),t._v("\n"),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("cmd.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("option")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'baz'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'<arg> description'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", { type: ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'string'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" })")])])])]),a("h2",{attrs:{id:"控制台日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#控制台日志"}},[t._v("#")]),t._v(" 控制台日志")]),t._v(" "),a("p",[t._v("Koishi v2 有了内置的 Logger 实现，结合对错误信息的处理，能够展现更好的控制台日志。")])],1)}),[],!1,null,null,null);s.default=c.exports}}]);